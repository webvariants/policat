<?php

/**
 * MediaFile
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    policat
 * @subpackage model
 * @author     Martin
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class MediaFile extends BaseMediaFile {

  const SPACE_LIMIT = 2097152; // 2MB
  const IMAGE_LIMIT = 204800;  // 200kb

  public function getUrl() {
    return $this->getPath() . '/' . $this->getFilename();
  }

  public function getPath() {
    return '/images/action/' . $this->getPetitionId();
  }

  public function getFilePath() {
    return sfConfig::get('sf_web_dir') . $this->getPath();
  }

  public function getFilePathname() {
    return $this->getFilePath() . '/' . $this->getFilename();
  }

  public function getFreeSpace() {
    $filesPetition = MediaFileTable::getInstance()->queryByPetitionId($this->getPetition()->getId())->execute();

    $usedSpace = 0;
    if ($filesPetition) {
      foreach ($filesPetition as $file) {
        $usedSpace += (int) $file->getSize();
      }
    }

    return self::SPACE_LIMIT - $usedSpace;
  }

  public function delete(\Doctrine_Connection $conn = null) {
    $ret = parent::delete($conn);

    if ($ret !== true) {
      return $ret;
    }

    $f = $this->getFilePathname();
    if (file_exists($f)) {
      !unlink($f);
    }

    return true;
  }

  public function getContents() {
    $f = $this->getFilePathname();
    if (file_exists($f)) {
      return file_get_contents($f);
    }

    return null;
  }

}
