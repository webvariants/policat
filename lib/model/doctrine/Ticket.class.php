<?php

/**
 * Ticket
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    policat
 * @subpackage model
 * @author     Martin
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Ticket extends BaseTicket {

  public function getKindName() {
    return TicketTable::$KIND_NAME[$this->getKind()];
  }

  public function getKindHandler() {
    return TicketTable::$KIND_HANDLER[$this->getKind()];
  }

  public function notifyAdmin() {
    $tos = array();

    if ($this->getToId()) {
      $email = $this->getTo()->getSwiftEmail();
      if ($email)
        $tos[] = $email;
    }

    if (!$tos && $this->getPetitionId()) {
      $prs = PetitionRightsTable::getInstance()->queryByPetitionAndAdmin($this->getPetition())->execute();
      foreach ($prs as $pr) { /* @var $pr PetitionRights */
        if ($pr->getUser()->isCampaignMember($this->getPetition()->getCampaign())) {
          $email = $pr->getUser()->getSwiftEmail();
          if ($email)
            $tos[] = $email;
        }
      }
    }

    if (!$tos && $this->getCampaignId()) {
      $crs = CampaignRightsTable::getInstance()->queryByCampaignAndAdmin($this->getCampaign())->execute();
      foreach ($crs as $cr) { /* @var $cr CampaignRights */
        $email = $cr->getUser()->getSwiftEmail();
        if ($email)
          $tos[] = $email;
      }
    }

    if ($tos) {
      $subject = 'Ticket-Notification';
      $body = "A new ticket about the following subject has been created:\n\n";
      $body.= "   Topic: " . $this->getKindName() . "\n";
      if ($this->getCampaignId())
        $body.= "Campaign: " . $this->getCampaign()->getName() . "\n";
      if ($this->getPetitionId())
        $body.= "  Action: " . $this->getPetition()->getName() . "\n";
      if ($this->getWidgetId())
        $body.= "  Widget: " . $this->getWidgetId() . "\n";
      if ($this->getFromId())
        $body.= "    User: " . $this->getFrom()->getFullName() . "\n";

      $body .= "\n\n" . sfContext::getInstance()->getRouting()->generate('dashboard', array(), true);

      foreach ($tos as $to)
        UtilMail::send(null, null, $to, $subject, $body);
    }
  }

}
