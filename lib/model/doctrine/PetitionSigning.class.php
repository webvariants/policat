<?php
/*
 * Copyright (c) 2015, webvariants GmbH & Co. KG, http://www.webvariants.de
 *
 * This file is released under the terms of the MIT license. You can find the
 * complete text in the attached LICENSE file or online at:
 *
 * http://www.opensource.org/licenses/mit-license.php
 */

/**
 * PetitionSigning
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    policat
 * @subpackage model
 * @author     Martin
 * @version    SVN: $Id: Builder.php 6820 2009-11-30 17:27:49Z jwage $
 */
class PetitionSigning extends BasePetitionSigning {

  const STATUS_PENDING = 1;
  const STATUS_VERIFIED = 2;
  const STATUS_BLOCKED = 3;
  const STATUS_DUPLICATE = 4;
  const STATUS_SENT = 5; // waves only

  static $STATUS_SHOW = array(
      self::STATUS_PENDING => 'pending',
      self::STATUS_VERIFIED => 'verified',
      self::STATUS_BLOCKED => 'blocked',
      self::STATUS_DUPLICATE => 'duplicate',
  );

  const VALIDATION_KIND_NONE = 0;
  const VALIDATION_KIND_EMAIL = 1;

  static $VALIDATION_KIND_SHOW = array(
      self::VALIDATION_KIND_NONE => 'none',
      self::VALIDATION_KIND_EMAIL => 'email'
  );

  const SUBSCRIBE_NO = 0;
  const SUBSCRIBE_YES = 1;

  public function getStatusName() {
    $status = $this->getStatus();
    return isset(self::$STATUS_SHOW[$status]) ? self::$STATUS_SHOW[$status] : 'unknown';
  }

  public function getField($name, $default = null) {
    if ($name instanceof Formfield || (is_array($name) && isset($name['name']))) {
      $name = $name['name'];
    }

    return $this->utilGetFieldFromArray('fields', $name, $default);
  }

  public function setField($name, $value) {
    if ($name instanceof Formfield || (is_array($name) && isset($name['name']))) {
      $name = $name['name'];
    }

    $this->utilSetFieldFromArray('fields', $name, $value);
  }

  public static function genCode() {
    return mt_rand(10000000000, 99999999999);
  }

  public static function getSecretHash() {
    return sfConfig::get('app_hashes_petition_signing');
  }

  public static function isValidTellcode($tellcode) {
    return UtilIdHash::getInstance(self::getSecretHash())->getIdByHash($tellcode);
  }

  public function getTellcode() {
    return UtilIdHash::getInstance(self::getSecretHash())->getHashById($this->getId());
  }

  public function getEmailContact($override_email = null, $via_tld = false) {
    $name_suffix = '';
    if ($via_tld) {
      $tld = $this->getRefTld();
      if ($tld) {
        $name_suffix = ' via ' . $tld;
      }
    }

    if ($override_email) {
      return array($override_email => $this->getComputedName() . $name_suffix);
    } else {
      return array($this->getField(Petition::FIELD_EMAIL) => $this->getComputedName() . $name_suffix);
    }
  }

  public function getComputedName() {
    $firstname = $this->getField(Petition::FIELD_FIRSTNAME);
    $lastname = $this->getField(Petition::FIELD_LASTNAME);
    $fullname = $this->getField(Petition::FIELD_FULLNAME);
    $name = array();
    if (!empty($firstname))
      $name[] = $firstname;
    if (!empty($lastname))
      $name[] = $lastname;
    if (!empty($fullname))
      $name[] = $fullname;
    return join(' ', $name);
  }

  public function getCountryName($culture = 'en') {
    try {
      $country = sfCultureInfo::getInstance($culture)->getCountry($this->getField(Petition::FIELD_COUNTRY));
    } catch (Exception $e) {
      $country = $this->getField(Petition::FIELD_COUNTRY);
    }
    return $country;
  }

  public function getComputedAddress($culture = 'en', $glue = "\n", $with_country = true, $with_name = true) {
    $address = $this->getField(Petition::FIELD_ADDRESS);
    $postcode = $this->getField(Petition::FIELD_POSTCODE);
    $city = $this->getField(Petition::FIELD_CITY);

    if ($with_name) {
      $ret = $this->getComputedName();
    } else {
      $ret = '';
    }
    if ($address)
      $ret .= $glue . $address;
    if ($city) {
      if ($postcode)
        $ret .= $glue . $postcode . ' ' . $city;
      else
        $ret .= $glue . $city;
    }
    else {
      if ($postcode)
        $ret .= $glue . $postcode;
    }

    if (!$with_country) {
      return $ret;
    }

    $country = $this->getCountryName($culture);
    if ($country) {
      $ret .= $glue . $country;
    }
    return $ret;
  }

  /**
   *
   * @param int $num
   * @return PetitionSigningWave
   */
  public function getWave($num) {
    foreach ($this->getPetitionSigningWave() as $wave) {
      /* @var $wave PetitionSigningWave */
      if ($wave->getWave() == $num)
        return $wave;
    }
    return null;
  }

  public function getSubst($culture = 'en') {
    return array(
        PetitionSigningTable::KEYWORD_NAME => $this->getComputedName(),
        PetitionSigningTable::KEYWORD_COUNTRY => $this->getCountryName($culture),
        PetitionSigningTable::KEYWORD_ADDRESS => $this->getComputedAddress($culture, "\n", false, false),
        PetitionSigningTable::KEYWORD_EMAIL => $this->getEmail(),
    );
  }

  public function getEmailScramble() {
    return UtilScrambleEmail::scramble($this->getEmail());
  }

  public function getEmailHashAuto() {
    return $this->getEmailHash() ? : UtilEmailHash::hash($this->getEmail());
  }

  public function getRefTld() {
    $ref = $this->getField(Petition::FIELD_REF);
    if ($ref) {
      $host = parse_url($ref, PHP_URL_HOST);
      if ($host) {
        $parts = explode('.', $host);
        $count = count($parts);
        if ($count > 1) {
          return $parts[$count - 2] . '.' . $parts[$count - 1];
        }
      }
    }

    return null;
  }

}
